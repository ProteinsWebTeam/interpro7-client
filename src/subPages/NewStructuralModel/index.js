import React, { useEffect, useRef, useState } from 'react';
import T from 'prop-types';

import { createSelector } from 'reselect';
import { format } from 'url';
import descriptionToPath from 'utils/processDescription/descriptionToPath';
import loadData from 'higherOrder/loadData';

import Link from 'components/generic/Link';
import FullScreenButton from 'components/SimpleCommonComponents/FullScreenButton';
import PictureInPicturePanel from 'components/SimpleCommonComponents/PictureInPicturePanel';

import StructureViewer from 'components/Structure/ViewerOnDemand';

import modelQuality from 'images/structural_model_quality.jpeg';
import { foundationPartial } from 'styles/foundation';
import ipro from 'styles/interpro-new.css';
import fonts from 'EBI-Icon-fonts/fonts.css';
import style from './style.css';

const f = foundationPartial(style, ipro, fonts);

const NewStructuralModel = ({ newModelApi, accession, data }) => {
  const [proteinAcc, setProteinAcc] = useState('');
  const container = useRef();
  const elementId = 'new-structure-model-viewer';

  const mockProteins = ['Q9SSD2', 'Q9T0I6', 'Q9FR53']; // To be removed
  // const mockProteins = ['Q9FR53']; // To be removed

  useEffect(() => {
    if (accession.toLowerCase().startsWith('ipr')) {
      // Take the list of matched UniProt matches and assign the first one to protein accession
      if (data.payload) {
        setProteinAcc(data.payload[0]);
      }
    } else {
      setProteinAcc(accession);
    }
    setProteinAcc(mockProteins[0]); // To be removed
  }, [accession, data]);

  // TODO construct urlForModel using the newModelApi and proteinAcc
  const urlForModel = `http://localhost/example/AF-${proteinAcc}-F1-model_v1.cif`;

  return (
    <div className={f('row', 'column')} ref={container}>
      {accession.toLowerCase().startsWith('ipr') && mockProteins.length > 1 ? (
        <div>
          The InterPro entry {accession} has matched the following UniProt
          proteins
          <select
            value={proteinAcc}
            onChange={() => setProteinAcc(event.target.value)}
            onBlur={() => setProteinAcc(event.target.value)}
          >
            {/*{data?.payload.map((protein) => (*/}
            {mockProteins.map((protein) => (
              <option key={protein}>{protein}</option>
            ))}
          </select>
        </div>
      ) : null}
      <h3>Predicted Model</h3>
      <div>
        The structural model below was generated by{' '}
        {/* TODO link to be updated */}
        <Link href="https://www.bakerlab.org/" target="_blank">
          XXX
        </Link>{' '}
        using the mysterious software . The model represents the entire sequence
        from UniProtKB: {proteinAcc} from Homo sapiens.
      </div>
      <div className={f('legend')}>
        <picture>
          <img alt="model quality" src={modelQuality} />
        </picture>
      </div>
      <PictureInPicturePanel
        className={f('structure-viewer')}
        testid="structure-3d-viewer"
        // OtherControls={{
        //   bottom: (
        //     <section className={f('lddt')}>
        //       <header>
        //         lDDT{' '}
        //         <Tooltip title="Quality score lDDT: Local Distance Difference Test">
        //           <sup>
        //             <span
        //               className={f('small', 'icon', 'icon-common')}
        //               data-icon="&#xf129;"
        //               aria-label={'Citation to trRosetta paper'}
        //             />
        //           </sup>
        //         </Tooltip>
        //         :{' '}
        //       </header>
        //       <code>
        //         {(
        //           data.payload.reduce((acc, cur) => acc + cur, 0) /
        //           data.payload.length
        //         )
        //           // eslint-disable-next-line no-magic-numbers
        //           .toFixed(6)}
        //       </code>
        //     </section>
        //   ),
        // }}
        OtherButtons={
          <>
            <Link
              className={f('control')}
              href={`${urlForModel}`}
              download={`${accession || 'download'}.model.cif`}
            >
              <span
                className={f('icon', 'icon-common', 'icon-download')}
                data-icon="&#xf019;"
              />{' '}
              Download
            </Link>
            <FullScreenButton
              className={f('icon', 'icon-common', 'control')}
              tooltip="View the structure in full screen mode"
              element={elementId}
            />{' '}
          </>
        }
      >
        <StructureViewer
          id={'fullSequence'}
          url={urlForModel}
          elementId={elementId}
          ext="mmcif"
          theme={'residue'}
        />
      </PictureInPicturePanel>
    </div>
  );
};

NewStructuralModel.propTypes = {
  newModelApi: T.object,
  accession: T.string,
  data: T.object,
};

const mapStateToPropsForModel = (typeOfData /*: 'match'|'structure' */) =>
  createSelector(
    (state) => state.settings.api,
    // TODO Add new structural model api to pass as prop for constructing 'urlForModel'
    (state) => state.settings.newModelApi,
    (state) => state.customLocation.description,
    ({ protocol, hostname, port, root }, newModelApi, description) => {
      if (
        description.main.key === 'entry' &&
        description[description.main.key].db === 'interpro'
      ) {
        const newDescription = {
          main: { key: 'entry' },
          entry: {
            db: description.entry.db || 'interpro',
            accession: description.entry.accession,
          },
        };
        // TODO Add appropriate interpro api query params
        // const key = `model:${typeOfData}`;
        if (typeOfData === 'match') {
          return format({
            protocol,
            hostname,
            port,
            pathname: root + descriptionToPath(newDescription),
            // query: {[key]: null},
          });
        }
      }
      return {
        newModelApi,
        accession: description[description.main.key].accession,
      };
    },
  );

export default loadData({
  getUrl: mapStateToPropsForModel('match'),
  mapStateToProps: mapStateToPropsForModel('structure'),
})(NewStructuralModel);
