name: CI Pipeline

on:
  push:
    branches:
      - dev  
      - stage
      - master
      - runner

jobs:
  build:
    runs-on: self-hosted 

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          clean: false
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1 

      - name: Install dependencies
        run: |
          npm install

      - name: Test
        run: |
          conda init bash
          source ~/.bashrc 
          conda activate base
          npm run test

      - name: Build
        run: | 
          npm run release:dev 

      - name: Release 
        run: |
          export VM_BASE_PATH="/nfs/www-prod/web_hx2/interpro/dev/website/releases/";
          export IPRO_RELEASE_FOLDER="interpro7-client-$(date --utc +%Y_%m_%d-%H_%M_%S_utc)";
          ssh wp-np3-bc "cd $VM_BASE_PATH; mkdir "${IPRO_RELEASE_FOLDER}"";
          scp -q -r dist/* wp-np3-bc:"$VM_BASE_PATH/$IPRO_RELEASE_FOLDER";