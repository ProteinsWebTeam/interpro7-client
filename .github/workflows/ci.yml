name: CI Pipeline

on:
  push:
    branches:
      - dev  
      - stage
      - master
      - runner
      - runner_vm

jobs:
  build:
    runs-on: self-hosted 

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          clean: false
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1 

      # - name: Install dependencies
      #   run: |
      #     npm install

      # - name: Test
      #   run: |
      #     conda init bash
      #     source ~/.bashrc 
      #     conda activate base
      #     export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:$LD_LIBRARY_PATH
      #     npm run test

      # - name: Build
      #   run: | 
      #     npm run release:dev 

      - name: Release 
        run: |

            if [[  "$({{ github.ref }})" == "refs/heads/runner" ]]; then
              export VM_BASE_PATH="/nfs/www-prod/web_hx2/interpro/dev/website/releases/";
              export VM_NAME = "wp-np3-bc";
            elif [[ sed "s/head\/ref//;s/\/\///" <<< ${{ github.ref }} == "stage" ]]; then
              export VM_BASE_PATH="/nfs/www-prod/web_hx2/interpro/stage/website/releases/";
              export VM_NAME = "wp-np3-bc";
            elif [[ sed "s/head\/ref//;s/\/\///" <<< ${{ github.ref }}== "master" ]]; then
              export VM_BASE_PATH="/nfs/www-prod/web_hx2/interpro/production/website/releases/";
              export VM_NAME = "wp-np3-bc";
            fi

            export IPRO_RELEASE_FOLDER="interpro7-client-$(date --utc +%Y_%m_%d-%H_%M_%S_utc)";
            ssh "$VM_NAME" "cd $VM_BASE_PATH; mkdir "${IPRO_RELEASE_FOLDER}"";
            scp -q -r dist/* "$VM_NAME":"$VM_BASE_PATH/$IPRO_RELEASE_FOLDER";